name: å‹é“¾ç”³è¯·åŒæ­¥åˆ°å¤–éƒ¨API

on:
  issues:
    types: [opened, edited, closed, reopened, deleted]

jobs:
  sync_friend_link:
    runs-on: ubuntu-latest
    
    steps:
      - name: å¤„ç†å‹é“¾ç”³è¯·
        env:
          API_KEY: ${{ secrets.FRIEND_LINK_API_KEY }}
        run: |
          # è®¾ç½®å˜é‡
          ACTION="${{ github.event.action }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          API_URL="https://blog-lac-eight-xt1307ke5s.vercel.app/issues/friendlink/$ACTION"
          
          # åˆ é™¤äº‹ä»¶ - åªå‘é€issue_number
          if [ "$ACTION" = "deleted" ]; then
            curl -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d "{\"issue_number\": $ISSUE_NUMBER}"
          else
            # æå–è¡¨å•æ•°æ®
            BODY='${{ github.event.issue.body }}'
            
            extract_field() {
              echo "$BODY" | awk -v field="$1" -v next_field="$2" '
                $0 ~ "### " field { found=1; next }
                $0 ~ "### " next_field { found=0 }
                found && NF { print $0 }
              ' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//'
            }
            
            TITLE=$(extract_field "ğŸ“ ç½‘ç«™åç§°" "ğŸ’¬ ç«™ç‚¹ä»‹ç»")
            BRIEF=$(extract_field "ğŸ’¬ ç«™ç‚¹ä»‹ç»" "ğŸ”— ç½‘ç«™é“¾æ¥") 
            URL=$(extract_field "ğŸ”— ç½‘ç«™é“¾æ¥" "ğŸ–¼ï¸ ç½‘ç«™å›¾æ ‡é“¾æ¥")
            ICON=$(extract_field "ğŸ–¼ï¸ ç½‘ç«™å›¾æ ‡é“¾æ¥" "ğŸ“‹ å¤‡æ³¨ä¿¡æ¯")
            REMARKS=$(extract_field "ğŸ“‹ å¤‡æ³¨ä¿¡æ¯" "")
            
            # æ„å»ºJSONæ•°æ® - ä½¿ç”¨printfé¿å…å¼•å·é—®é¢˜
            JSON_STRING=$(printf '{"issue_number": %s, "issue_title": "%s", "issue_state": "%s", "issue_url": "%s", "created_at": "%s", "updated_at": "%s", "user_login": "%s", "user_url": "%s", "site_title": "%s", "site_brief": "%s", "site_url": "%s", "site_icon": "%s", "remarks": "%s", "repository": "%s"}' "$ISSUE_NUMBER" "${{ github.event.issue.title }}" "${{ github.event.issue.state }}" "${{ github.event.issue.html_url }}" "${{ github.event.issue.created_at }}" "${{ github.event.issue.updated_at }}" "${{ github.event.issue.user.login }}" "${{ github.event.issue.user.html_url }}" "$TITLE" "$BRIEF" "$URL" "$ICON" "$REMARKS" "${{ github.repository }}")
            
            # å‘é€åˆ°API
            curl -X POST "$API_URL" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $API_KEY" \
              -d "$JSON_STRING"
          fi