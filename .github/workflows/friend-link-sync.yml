name: å‹é“¾ç”³è¯·åŒæ­¥åˆ°å¤–éƒ¨API

on:
  issues:
    types: [opened, edited, closed, reopened, deleted]

jobs:
  sync_friend_link:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'å‹é“¾ç”³è¯·')
    
    steps:
      - name: å‘é€å‹é“¾ç”³è¯·æ•°æ®åˆ°API
        env:
          API_KEY: ${{ secrets.FRIEND_LINK_API_KEY }}
        run: |
          # å¯¹äº deleted äº‹ä»¶ï¼Œåªå‘é€ issue_number
          if [ "${{ github.event.action }}" = "deleted" ]; then
            JSON_DATA='{"issue_number": '${{ github.event.issue.number }}'}'
          else
            # ä»issue bodyä¸­æå–è¡¨å•æ•°æ®
            BODY='${{ github.event.issue.body }}'
            
            extract_field() {
              echo "$BODY" | awk -v field="$1" -v next_field="$2" '
                $0 ~ "### " field { found=1; next }
                $0 ~ "### " next_field { found=0 }
                found && NF { print $0 }
              ' | sed 's/^[[:space:]]*//; s/[[:space:]]*$//'
            }
            
            TITLE=$(extract_field "ğŸ“ ç½‘ç«™åç§°" "ğŸ’¬ ç«™ç‚¹ä»‹ç»")
            BRIEF=$(extract_field "ğŸ’¬ ç«™ç‚¹ä»‹ç»" "ğŸ”— ç½‘ç«™é“¾æ¥") 
            URL=$(extract_field "ğŸ”— ç½‘ç«™é“¾æ¥" "ğŸ–¼ï¸ ç½‘ç«™å›¾æ ‡é“¾æ¥")
            ICON=$(extract_field "ğŸ–¼ï¸ ç½‘ç«™å›¾æ ‡é“¾æ¥" "ğŸ“‹ å¤‡æ³¨ä¿¡æ¯")
            REMARKS=$(extract_field "ğŸ“‹ å¤‡æ³¨ä¿¡æ¯" "")
            
            # æ„å»ºJSONæ•°æ®
            JSON_DATA=$(cat << EOF
            {
              "issue_number": ${{ github.event.issue.number }},
              "issue_title": "${{ github.event.issue.title }}",
              "issue_state": "${{ github.event.issue.state }}",
              "issue_url": "${{ github.event.issue.html_url }}",
              "created_at": "${{ github.event.issue.created_at }}",
              "updated_at": "${{ github.event.issue.updated_at }}",
              "user_login": "${{ github.event.issue.user.login }}",
              "user_url": "${{ github.event.issue.user.html_url }}",
              "site_title": "$TITLE",
              "site_brief": "$BRIEF",
              "site_url": "$URL",
              "site_icon": "$ICON",
              "remarks": "$REMARKS",
              "repository": "${{ github.repository }}"
            }
            EOF
            )
          fi
          
          # å‘é€åˆ°API
          curl -X POST "http://61.150.125.46:3000/issues/friendlink/${{ github.event.action }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -d "$JSON_DATA"