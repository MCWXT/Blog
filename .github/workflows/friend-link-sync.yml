name: å‹é“¾ç”³è¯·åŒæ­¥åˆ°å¤–éƒ¨API

on:
  issues:
    types: [opened, edited, closed, reopened, deleted]

jobs:
  sync_friend_link:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'å‹é“¾ç”³è¯·')
    
    steps:
      - name: æå–è¡¨å•æ•°æ®å¹¶å‘é€åˆ°API
        env:
          API_KEY: ${{ secrets.FRIEND_LINK_API_KEY }}
          CLOUDFLARE_BYPASS: ${{ secrets.CLOUDFLARE_BYPASS_TOKEN }}
        run: |
          # ä»issue bodyä¸­æå–è¡¨å•æ•°æ®
          BODY='${{ github.event.issue.body }}'
          
          extract_field() {
            echo "$BODY" | grep -A 1 "$1" | tail -1 | sed 's/^\*\*//' | sed 's/\*\*$//' | xargs
          }
          
          TITLE=$(extract_field "ç½‘ç«™åç§°")
          BRIEF=$(extract_field "ç«™ç‚¹ä»‹ç»") 
          URL=$(extract_field "ç½‘ç«™é“¾æ¥")
          ICON=$(extract_field "ç½‘ç«™å›¾æ ‡é“¾æ¥")
          REMARKS=$(extract_field "å¤‡æ³¨ä¿¡æ¯")
          
          # æ„å»ºJSONæ•°æ®
          JSON_DATA=$(cat << EOF
          {
            "issue_number": ${{ github.event.issue.number }},
            "issue_title": "${{ github.event.issue.title }}",
            "issue_state": "${{ github.event.issue.state }}",
            "issue_url": "${{ github.event.issue.html_url }}",
            "created_at": "${{ github.event.issue.created_at }}",
            "updated_at": "${{ github.event.issue.updated_at }}",
            "user_login": "${{ github.event.issue.user.login }}",
            "user_url": "${{ github.event.issue.user.html_url }}",
            "site_title": "$TITLE",
            "site_brief": "$BRIEF",
            "site_url": "$URL",
            "site_icon": "$ICON",
            "remarks": "$REMARKS",
            "repository": "${{ github.repository }}"
          }
          EOF
          )
          
          echo "ğŸš€ å‘é€è¯·æ±‚ï¼ˆç»•è¿‡Cloudflareä¿æŠ¤ï¼‰..."
          
          # æ·»åŠ  Cloudflare ç»•è¿‡å¤´
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.mcwxt.top/issues/friendlink/${{ github.event.action }}" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $API_KEY" \
            -H "User-Agent: GitHub-Actions-Webhook/1.0" \
            -H "CF-Access-Client-Id: $CLOUDFLARE_BYPASS" \
            -H "X-Forwarded-For: 1.1.1.1" \
            -d "$JSON_DATA")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTPçŠ¶æ€ç : $HTTP_CODE"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… è¯·æ±‚æˆåŠŸ"
          else
            echo "âŒ è¯·æ±‚å¤±è´¥"
            echo "å“åº”é¢„è§ˆ:"
            echo "$RESPONSE_BODY" | head -c 500
            exit 1
          fi