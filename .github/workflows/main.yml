name: Package Issues to JSON

on:
  issues:
    types: [opened, edited, closed, reopened, deleted]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  package_issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Fetch only OPEN issues from GitHub API
        run: |
          curl -X GET 'https://api.github.com/repos/${{ github.repository }}/issues?state=open&labels=%E5%8F%8B%E9%93%BE%E7%94%B3%E8%AF%B7&per_page=100' \
            -H 'Accept: application/vnd.github.v3+json' \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -o issues.json

      - name: Parse issues to JSON array with ID via jq
        run: |
          jq '
            [ .[]
              | select(.body != null and .body != "")
              | {
                  id:      .number,
                  parts:   (.body | split("\\n\\n")),
                  title:   (.body | split("\\n\\n")[1]),
                  content: (.body | split("\\n\\n")[3]),
                  href:    (.body | split("\\n\\n")[5]),
                  icon:    (.body | split("\\n\\n")[7])
                }
              | { id, title, content, href, icon }
            ]
          ' issues.json > issues.json

      - name: Upload to Cloudflare R2
        env:
          AWS_ACCESS_KEY_ID:     ${{ secrets.CLOUDFLARE_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.CLOUDFLARE_SECRET_ACCESS_KEY }}
        run: |
          pip install awscli
          aws s3 cp issues.json s3://blog/data/json/issues.json \
            --endpoint-url https://05b69c2cf1cc6b7312bd86130ff3d5f3.r2.cloudflarestorage.com \
            --region auto \
            --acl public-read